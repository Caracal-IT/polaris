import{r as t,g as s}from"./p-b48df0bd.js";const i=class{constructor(s){t(this,s)}async analyticsHandler(t){const s=i.analyticsService.getPath(t);i.lastPath[0]!==s[0]&&(i.lastPath=s,s.find(t=>void 0!==t["wf-Workflow"])&&(s[0].addEventListener("blur",this.onBlur),i.analyticsService.send("click",s)))}wfMessage(t){i.analyticsService.sendMessage(t)}onBlur(t){i.analyticsService.send("blur",i.lastPath),t.target.removeEventListener("blur",this.onBlur)}};i.lastPath=[null],i.analyticsService=new class{sendMessage(t){this.sendPostMessage(t.detail)}send(t,s){const i=s.find(t=>void 0!==t["wf-Workflow"]);if(!i)return;const e=this.createPayload(t,i,s);e&&this.sendPostMessage({type:e.type,process:e.process,activity:e.activity,control:e.control,valueHash:e.valueHash,path:e.wfPath.map(this.getName)})}getPath(t){return t.composedPath(t)}sendPostMessage(t){const s=Object.assign(Object.assign({},t),{timestamp:Date.now()});console.log("ANALYTICS",s),window.postMessage(s,"*")}getName(t){return t.id?t.id:t.page&&t.page.name?t.page.name:""}createPayload(t,s,i){const e=i.filter(t=>t.nodeName&&-1===t.nodeName.indexOf("document-fragment")),r=e.find(t=>"polaris-workflow"===t.localName);if(!r)return null;const n=r.ctx.wf.activity,h=e.slice(0,e.indexOf(r)+1);return n.name?{type:t,process:r.ctx.wf.process.name,activity:n.name,control:s.id,valueHash:this.getHashCode(s.value),wfPath:h}:null}getHashCode(t){let s,i=0;if(!t||0===t.length)return i;for(let e=0;e<t.length;e++)s=t.charCodeAt(e),i=(i<<5)-i+s,i|=0;return i}};class e{constructor(t){this.ctx=t}async fetch(t){return(await fetch(this.resolveSetting(t.url),this.getConfig(t))).json()}getConfig(t){return{method:t.method,mode:"cors",headers:Object.apply({"Content-Type":"application/json"},t.headers),redirect:"follow",referrer:"no-referrer",body:t.body?JSON.stringify(t.body):null}}resolveSetting(t){const s=t.match(/\[[\w|_]+\]/g);return s?s.reduce((t,s)=>t.replace(s,this.ctx.config.getSetting(s)),t):t}}class r{constructor(){this.model={}}getValue(t,s=this.model){return t.split(".").reduce((t,s)=>t?t[s]:void 0,Object.assign({},s))}setValue(t,s){this.model=this.merge(this.model,t,s)}merge(t,s,i){if(!s)return;let e=Object.assign({},t);return s.split(".").reduce((t,s,e,r)=>(t[s]=e==r.length-1?i:Object.assign({},t[s]),t[s]),e),e}}class n{constructor(){this.settings={"[WF]":"polaris/wf"}}getSetting(t){return this.settings[t]}}class h{constructor(){this.name="undefined",this.type="null-activity"}execute(){return new Promise((t,s)=>s())}}class o{static create(t,s){if(!t||!t.type)return new h;let i=o.activities.find(s=>s.type===t.type);return i?Object.assign(i,t,{ctx:s}):new h}}o.activities=[new h,new class{constructor(){this.name="start",this.type="page-activity"}async execute(){return this.ctx&&this.ctx.page&&this.ctx.page.controls&&(this.ctx.page.controls=this.controls||[]),!0}},new class{constructor(){this.name="start",this.type="api-activity"}async execute(){return this.endpoints&&this.endpoints.length>0?this.callEndpoints():this.next&&this.ctx&&this.gotoNext(),!0}callEndpoints(){if(!this.ctx||!this.ctx.http||!this.endpoints)return;let t=0;const s=this.callEndpoint.bind(this,this.ctx.http);this.endpoints.forEach(i=>{t++,i.body=this.getBody(i),s(i).finally(()=>{t--,0===t&&this.gotoNext()})})}async callEndpoint(t,s){if(this.ctx&&this.ctx.config)return t.fetch(s).then(t=>this.setModel(s,t))}gotoNext(){this.next&&this.ctx&&this.ctx.wf.goto(this.next)}getBody(t){if(!this.ctx||!this.ctx.model||"GET"===t.method.toUpperCase()||"DELETE"===t.method.toUpperCase())return null;const s=this.ctx.model;let i={};return t.mappings.filter(t=>"out"===t.direction||"inout"===t.direction).forEach(t=>Object.assign(i,{[t.client]:s.getValue(t.client)})),JSON.stringify(i)}setModel(t,s){if(!this.ctx||!this.ctx.model)return;const i=this.ctx.model,e=t.mappings;if(!e||0===e.length)return Object.keys(s).forEach(t=>i.setValue(t,s[t]));e.filter(t=>"in"===t.direction||"inout"===t.direction).forEach(t=>i.setValue(t.client,i.getValue(t.remote,s)))}}];class c{constructor(t){this.ctx=t}async setProcess(t,s="start"){try{"string"==typeof t&&(t=await this.ctx.http.fetch({url:`/wf/${t}`,method:"get"})),this.process=t,await this.goto(s)}catch(i){console.error(i)}}async goto(t){if(this.process&&this.process.activities)return this.activity=this.process.activities.find(s=>s.name==t),o.create(this.activity,this.ctx).execute()}}const a=class{constructor(s){t(this,s),this.page=this,this.model=new r,this.http=new e(this),this.config=new n,this.wf=new c(this),this._components=[],this.ctx=this}processChangeHandler(){this._render()}get controls(){return this._components}set controls(t){this._components=t,this._render()}load(t,s="start"){this.wf.setProcess(t,s)}componentWillLoad(){this.process&&this.load(this.process)}_render(){for(let t=this.el.childNodes.length-1;t>=0;t--)this.el.removeChild(this.el.childNodes[t]);this.controls.forEach(this.renderComponent.bind(this,this.el))}renderComponent(t,s){const i=document.createElement(s.tag),e=Object.assign(i,s,{"wf-Workflow":"",ctx:this});if(e.id&&void 0!==e.value){const t=this.model.getValue(e.id);void 0!==t&&(e.value=t),this.model.setValue(e.id,e.value),e.onchange=t=>this.model.setValue(t.target.id,t.target.value)}s.controls&&s.controls.forEach(this.renderComponent.bind(this,e)),t.appendChild(e)}get el(){return s(this)}static get watchers(){return{process:["processChangeHandler"]}}};export{i as polaris_analytics,a as polaris_workflow};