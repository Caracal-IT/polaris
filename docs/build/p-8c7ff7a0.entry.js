import{r as t,c as s,g as i}from"./p-08a47141.js";class e{sendMessage(t){this.sendPostMessage(t["detail"])}send(t,s){const i=s.find((t=>t["wf-Workflow"]!==undefined));if(!i)return;const e=this.createPayload(t,i,s);if(e!==undefined&&e!==null){this.sendPostMessage({type:e.type,process:e.process,activity:e.activity,control:e.control,valueHash:e.valueHash,path:e.wfPath.map(this.getName)})}}getPath(t){return t.composedPath(t)}sendPostMessage(t){const s={...t,timestamp:Date.now()};console.log("ANALYTICS",s);window.postMessage(s,"*")}getName(t){if(t.id!=null)return t.id;if(t.page!==null&&t.page.name!==null)return t.page.name;return""}createPayload(t,s,i){const e=-1;if(i==null||i==undefined)return null;const n=i.filter((t=>t.nodeName!==undefined&&t.nodeName!==null&&t.nodeName.indexOf("document-fragment")===e));const r=n.find((t=>t.localName==="polaris-workflow"));if(r===null)return null;const o=r;const c=o.ctx.wf.activity;const h=n.slice(0,n.indexOf(r)+1);if(c.name===undefined||c.name===null)return null;const u=o.ctx.wf.process.name;const l=c.name;const a=s.id;const d=this.getHashCode(s["value"]);return{type:t,process:u,activity:l,control:a,valueHash:d,wfPath:h}}getHashCode(t){if(t===undefined||t===null)return 0;const s=0;const i=31;let e=s;for(let n=s;n<t.length;n=n+1)e=Math.imul(i,e)+t.charCodeAt(n);return e}}const n=class{constructor(s){t(this,s)}async analyticsHandler(t){const s=n.analyticsService.getPath(t);if(n.lastPath[0]===s[0])return;n.lastPath=s;const i=s.find((t=>t["wf-Workflow"]!==undefined));if(!i)return;s[0].addEventListener("blur",this.onBlur);n.analyticsService.send("click",s)}wfMessage(t){n.analyticsService.sendMessage(t)}onBlur(t){n.analyticsService.send("blur",n.lastPath);t.target.removeEventListener("blur",this.onBlur)}};n.lastPath=[null];n.analyticsService=new e;class r{constructor(t){this.ctx=t;this.notFound=-1;this.startIndex=0;this.settingOffset=2;this.clientError=400;this.unAuthorizedError=401}async fetch(t){try{this.ctx.page.sendMessage({type:"START_LOADING"});const s=await fetch(this.resolveSetting(t.url),this.getConfig(t));if(s.status>=this.clientError){const i=await s.json();if(s.status>=this.unAuthorizedError)this.ctx.page.sendMessage({type:"UN_AUTHORIZED",metadata:{endpoint:t,error:i}});throw{code:s.status,message:s.statusText,error:i}}return await s.json()}finally{setTimeout((()=>this.ctx.page.sendMessage({type:"END_LOADING"})))}}getConfig(t){const s={method:t.method,mode:"cors",headers:Object.apply({"Content-Type":"application/json"},t.headers),redirect:"follow",referrer:"no-referrer",body:t.body!==null?JSON.stringify(t.body):null};return s}resolveSetting(t,s=this.startIndex){if(s>this.settingOffset)return t;const i=t.match(/\[[\w|_]+\]/g);if(i===null)return t;let e=i.reduce(this.replace.bind(this),t);if(e.indexOf("[")>this.notFound)e=this.resolveSetting(e,s+1);return e}replace(t,s){let i=this.ctx.config.getSetting(s);if(i!==null&&i.indexOf("[SELF]")>this.notFound)return i.replace("[SELF]",t.replace(s,""));return t.replace(s,i)}}function o(t,[s,i]){const e=new Intl.NumberFormat(s,{style:"currency",currency:i});return e.format(+t)}class c{constructor(){this.currencyFormat=o}}let h;const u=new Uint8Array(16);function l(){if(!h){h=typeof crypto!=="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto);if(!h){throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported")}}return h(u)}const a=[];for(let t=0;t<256;++t){a.push((t+256).toString(16).slice(1))}function d(t,s=0){return(a[t[s+0]]+a[t[s+1]]+a[t[s+2]]+a[t[s+3]]+"-"+a[t[s+4]]+a[t[s+5]]+"-"+a[t[s+6]]+a[t[s+7]]+"-"+a[t[s+8]]+a[t[s+9]]+"-"+a[t[s+10]]+a[t[s+11]]+a[t[s+12]]+a[t[s+13]]+a[t[s+14]]+a[t[s+15]]).toLowerCase()}const f=typeof crypto!=="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const p={randomUUID:f};function y(t,s,i){if(p.randomUUID&&!s&&!t){return p.randomUUID()}t=t||{};const e=t.random||(t.rng||l)();e[6]=e[6]&15|64;e[8]=e[8]&63|128;if(s){i=i||0;for(let t=0;t<16;++t){s[i+t]=e[t]}return s}return d(e)}class w{constructor(t){this.config=t;this.model={};this.sessionId=y().replaceAll("-","R");this.pipes=new c}getValue(t,s=this.model){if(t.indexOf("[")===0||t.indexOf("]")===t.length-1)return this.config.getSetting(t);const i=t.split(".").reduce(((t,s)=>t!=null?t[s]:undefined),{...s});if(t.match(/([a-z|A-Z]+\.[a-z|A-Z]+)+/g)===null&&i===undefined)return t;return i}getInterpolatedValue(t){if(t===undefined||t===null)return t;const s=/\{\{\[*(?:(\w|\.|\||-)+)\]*\}\}/g;const i=t.match(s);if(i===null||i.length===0)return t;return i.reduce(((t,s)=>this.replaceAll(t,s)),t)}setValue(t,s){if(t.indexOf("[")===0||t.indexOf("]")===t.length-1)this.config.addSetting(t,s);else this.model=this.merge(this.model,t,s)}save(){sessionStorage.setItem(this.sessionId,JSON.stringify(this.model))}load(){const t=sessionStorage.getItem(this.sessionId);this.clearCache();if(t===null)return;this.model=JSON.parse(t)}clearCache(){sessionStorage.clear()}merge(t,s,i){if(s===null)return;let e={...t};s.split(".").reduce(((t,s,e,n)=>{t[s]=e===n.length-1?i:{...t[s]};return t[s]}),e);return e}replaceAll(t,s){const i=2;const e=2;const n=0;const r=1;const o=s.substring(i,s.length-i);const c=o.split("|");const h=c.slice(e);let u=this.getValue(c[n]);if(c!=null&&c.length>1&&this.pipes[c[r]]!=null)u=this.pipes[c[r]](u,h);return t.replace(s,u)}}class g{constructor(){this.settings={}}getSetting(t){return this.settings[t]}addSetting(t,s){if(t.indexOf("[")===-1)t=`[${t}]`;this.settings[t]=s}}class v{gotoNext(){if(this.next!==undefined&&this.ctx!==undefined)this.ctx.wf.goto(this.next)}}class m extends v{constructor(){super(...arguments);this.name="redirect";this["type"]="redirect-activity"}async execute(){var t;this.ctx.model.save();const s=`${(t=this.ctx.wf.process)===null||t===void 0?void 0:t.name}-${this.next}-${this.ctx.model.sessionId}`;window.location.href=`${this.location}?returnUrl=${s}`;return true}}class x extends v{constructor(){super(...arguments);this.name="finish";this["type"]="finish-activity"}async execute(){if(this.ctx.wf.stack.length===0){this.gotoNext();return true}const t=this.ctx.wf.stack.pop();await this.ctx.wf.setProcess(t.process,t.activity);return true}}class E extends v{constructor(){super(...arguments);this.name="ipc";this["type"]="ipc-activity"}async execute(){if(this.process!==null&&this.process.length>0){this.ctx.wf.stack.push({process:this.ctx.wf.process.name,activity:this.next});await this.ctx.wf.setProcess(this.ctx.model.getInterpolatedValue(this.process),"start",this.next!==undefined?false:true)}return true}}class O extends v{constructor(){super(...arguments);this.name="code";this["type"]="code-activity"}async execute(){this.evaluate(this.expression,this.ctx);this.gotoNext();return true}evaluate(t,s){const i=new Function("ctx",t);return i(s)}}class b{constructor(){this.name="start";this["type"]="page-activity"}async execute(){this.ctx.page.controls=this.controls;return true}}class N{constructor(){this.name="undefined";this["type"]="null-activity"}async execute(){return new Promise(((t,s)=>s("NULL Activity")))}}class A extends v{constructor(){super(...arguments);this.name="start";this["type"]="api-activity"}async execute(){await this.callEndpoints();this.gotoNext();return true}async callEndpoints(){for(const t of this.endpoints){t.body=this.getBody(t);await this.callEndpoint(this.ctx.http,t)}return true}async callEndpoint(t,s){return t.fetch(s).then((t=>this.setModel(s,t)))}getBody(t){if(!this.hasModel()||t.method.toUpperCase()==="GET"||t.method.toUpperCase()==="DELETE")return null;const s=this.ctx.model;const i=t.mappings;let e={};i.filter((t=>t.direction==="out"||t.direction==="inout")).forEach((t=>Object.assign(e,{[t.remote]:s.getValue(t.client)})));return e}setModel(t,s){if(!this.hasModel())return;const i=this.ctx.model;const e=t.mappings;if(e===null||e.length===0)return Object.keys(s).forEach((t=>i.setValue(t,s[t])));e.filter((t=>t.direction==="in"||t.direction==="inout")).forEach((t=>i.setValue(t.client,i.getValue(t.remote,s))))}hasModel(){return this.ctx!==undefined&&this.ctx!==null&&this.ctx.model!==undefined&&this.ctx.model!==null}}class C extends v{constructor(){super(...arguments);this.name="assign";this["type"]="assign-activity"}async execute(){const t=this.ctx.model.getInterpolatedValue(this.value);this.ctx.model.setValue(this.key,t);this.gotoNext();return true}}class R extends O{constructor(){super(...arguments);this.name="decision";this["type"]="decision-activity"}async execute(){const t=`return ${this.ctx.model.getInterpolatedValue(this.expression)};`;if(this.evaluate(t,this.ctx))this.ctx.wf.goto(this.trueAction);else this.ctx.wf.goto(this.falseAction);return true}}class S extends O{constructor(){super(...arguments);this.name="switch";this["type"]="switch-activity"}async execute(){if(this.rules===null||this.rules===undefined)throw new Error(`No valid rule in ${this.name} found !!`);for(let t of this.rules){const s=`return ${this.ctx.model.getInterpolatedValue(t.expression)};`;if(this.evaluate(s,this.ctx)){this.gotoNext();return true}}throw new Error(`No valid rule in ${this.name} found !!`)}}class L{static create(t,s){if(t===null||t===undefined||t["type"]===undefined||t["type"]===null)return new N;let i=L.activities.find((s=>s["type"]===t["type"]));if(i==null)return new N;return Object.assign(i,t,{ctx:s})}static add(t,s=false){const i=-1;const e=1;let n=L.activities.findIndex((s=>s.type===t.type));if(n>i&&!s)return;if(n>i)L.activities.splice(n,e);L.activities.push(t)}}L.activities=[new N,new b,new A,new C,new O,new R,new E,new x,new m,new S];class T{constructor(t){this.ctx=t;this.stack=[]}async setProcess(t,s="start",i=true){try{if(i)this.stack=[];if(typeof t==="string"&&this.loader!=null)t=await this.loader.load(t);if(typeof t==="string")return Promise.reject("Workflow not found");this.process=t;this.activity=null;this.goto(s);this.ctx.page.sendMessage({type:"PROCESS_CHANGED",metadata:{stack:this.stack}})}catch(t){if(t){console.error(t);this.ctx.page.sendMessage({type:"ERROR",description:t.message,metadata:t})}}}goto(t){setTimeout(this.tryNext.bind(this,t))}async tryNext(t){try{this.ctx.page.sendMessage({type:"WORKFLOW_CHANGING"});await this.next(t);this.ctx.page.sendMessage({type:"WORKFLOW_CHANGED"})}catch(t){this.ctx.page.sendMessage({type:"ERROR",description:t===null||t===void 0?void 0:t.message,metadata:t})}}async next(t){var s;if(!this.isValidProcess())return null;if(((s=this.ctx.wf.activity)===null||s===void 0?void 0:s.type)==="page-activity"&&!this.ctx.validator.validate(this.ctx))return null;let i=this.process.activities.find((s=>s.name===t));if(!i)throw new Error(`Activity ${t} not found`);this.activity=i;return L.create(this.activity,this.ctx).execute()}isValidProcess(){return typeof this.process!=="string"&&this.process!==undefined&&this.process!==null&&this.process.activities!==undefined&&this.process.activities!==null}}class ${constructor(t){this.name=t}setError(t,s,i){t.error=s;t.errorMessage=s?i:null;if(t.el!==null){t.el.setAttribute("error",t.error===true?"true":"false");t.el.setAttribute("errorMessage",t.errorMessage)}if(t.el.nextSibling["attributes"]["wf-error"])t.el.nextSibling.textContent=t.errorMessage}}class k extends ${validate(t,s,i){const e=t.model.getValue(s.id);const n=e===null||e===undefined||e.length===0;super.setError(s,n,i.message);return!n}}class D extends ${validate(t,s,i){const e=t.model.getValue(s.id);const n=new RegExp(i.expression,"g");const r=n.exec(e);const o=r!=null?true:false;super.setError(s,!o,i.message);return o}}class H extends ${validate(t,s,i){const e=+t.model.getValue(s.id);const n=e>=i.min&&e<=i.max;super.setError(s,!n,i.message);return n}}class I{constructor(){this.validators=[new k("required"),new D("regex"),new H("range")]}validate(t){if(t.page===undefined||t.page===null||t.page.controls===undefined||t.page.controls===null)return true;let s=true;for(const i of t.page.controls)s=this.validateControl(t,i)&&s;return s}addValidator(t){const s=this.validators.find((s=>s.name===t.name));if(!s)this.validators.push(t)}validateControl(t,s){if(s===undefined||s===null)return true;let i=true;for(const e in s.controls)i=this.validateControl(t,s.controls[e])&&i;if(s.validators!==null&&s.validators!==undefined&&s.validators.length>0){for(const e of s.validators){const n=this.validators.find((t=>t.name===e.name));if(!n)continue;if(!n.validate(t,s,e)){i=false;this.sendErrorMsg(t,n,s);break}}}return i}sendErrorMsg(t,s,i){t.page.sendMessage({type:"VALIDATION_ERROR",description:i.errorMessage,metadata:{validator:s.name,control:i.id}})}}class M{constructor(t){this.ctx=t}build(t,s){this.onInput=s;this.clearPage(t);this.ctx.controls.forEach(this.addComponent.bind(this,t))}clearPage(t){for(let s=t.childNodes.length-1;s>=0;s--)t.removeChild(t.childNodes[s])}addComponent(t,s){let i;if(s.tag==="polaris-workflow")i=this.createWorkflowElement(s);else i=this.createElement(s);t.appendChild(i);this.addErrorLabel(i)}createWorkflowElement(t){const s=document.createElement(t.tag);const i=Object.assign(s,t);i.setServices(this.ctx);return i}createElement(t){var s;const i=document.createElement(t.tag);const e={"wf-Workflow":"",ctx:this.ctx};const n=Object.assign(i,t,e);t.el=n;this.bind(n);this.bindCaption(n,t);(s=t.controls)===null||s===void 0?void 0:s.forEach(this.addComponent.bind(this,n));return n}bind(t){if(!t.id||t.value===undefined)return;const s=this.ctx.model.getValue(t.id);if(s!==undefined)t.value=s;this.ctx.model.setValue(t.id,t.value);t.oninput=this.onInput.bind(this,t)}bindCaption(t,s){this.interpolate("caption",t,s);this.interpolate("textContent",t,s);this.interpolate("innerHTML",t,s)}interpolate(t,s,i){if(!s[t])return;s[t]=this.ctx.model.getInterpolatedValue(i[t]||s[t])}addErrorLabel(t){if(!t.validators)return;const s=document.createElement("span");s.setAttribute("wf-error","error");t.parentNode.appendChild(s)}}class P{constructor(t){this.http=t}async load(t){return this.http.fetch({url:`[WF]/${t}`,method:"get"})}}const _=class{constructor(i){t(this,i);this.wfMessage=s(this,"wfMessage",7);this._components=[];this.page=this;this.ctx=this;this.http=new r(this.ctx);this.config=new g;this.model=new w(this.ctx.config);this.wf=new T(this.ctx);this.validator=new I}async processChangeHandler(){await this.load(this.process,this.activity,this.sessionId)}get controls(){return this._components}set controls(t){this._components=t;this._render()}async setServices(t){this.model=t.model;this.http=t.http;this.config=t.config;this.validator=t.validator}async load(t,s="start",i=""){if(i!=null&&i.length>0){this.ctx.model.sessionId=i;this.ctx.model.load()}await this.wf.setProcess(t,s)}async addActivity(t,s=false){L.add(t,s);return Promise.resolve()}async addValidator(t){this.validator.addValidator(t)}sendMessage(t){var s,i,e;const n={process:(s=this.wf.process)===null||s===void 0?void 0:s.name,activity:(i=this.wf.activity)===null||i===void 0?void 0:i.name,activityType:(e=this.wf.activity)===null||e===void 0?void 0:e.type,timestamp:Date.now()};if(this._isConnected===true)this.wfMessage.emit({...t,...n})}disconnectedCallback(){this._isConnected=false}connectedCallback(){this._isConnected=true}async componentWillLoad(){if(this.url!=null){this.config.addSetting("[settingsUrl]",this.url);const t=await this.http.fetch({method:"GET",url:this.url});Object.keys(t).forEach((s=>this.config.addSetting(s,t[s])))}if(this._loader===null||this._loader===undefined){this._loader=new P(this.http);this.wf.loader=this._loader}if(this.parent!=null)await this.setServices(this.parent);if(this.process!=null)await this.load(this.process,this.activity,this.sessionId)}onInput(t){this.model.setValue(t.id,t.value);if(t.hasAttribute("error"))this.validator.validate(this)}_render(){const t=new M(this);t.build(this.el,this.onInput.bind(this))}get el(){return i(this)}static get watchers(){return{process:["processChangeHandler"]}}};export{n as polaris_analytics,_ as polaris_workflow};
//# sourceMappingURL=p-8c7ff7a0.entry.js.map