System.register(["./p-0a790a0b.system.js"],(function(t){"use strict";var e,s,i;return{setters:[function(t){e=t.r;s=t.c;i=t.g}],execute:function(){class n{sendMessage(t){this.sendPostMessage(t.detail)}send(t,e){const s=e.find(t=>t["wf-Workflow"]!==undefined);if(!s)return;const i=this.createPayload(t,s,e);if(i){this.sendPostMessage({type:i.type,process:i.process,activity:i.activity,control:i.control,valueHash:i.valueHash,path:i.wfPath.map(this.getName)})}}getPath(t){return t.composedPath(t)}sendPostMessage(t){const e=Object.assign(Object.assign({},t),{timestamp:Date.now()});console.log("ANALYTICS",e);window.postMessage(e,"*")}getName(t){if(t.id)return t.id;if(t.page&&t.page.name)return t.page.name;return""}createPayload(t,e,s){const i=s.filter(t=>t.nodeName&&t.nodeName.indexOf("document-fragment")===-1);const n=i.find(t=>t.localName==="polaris-workflow");if(!n)return null;const r=n.ctx.wf.activity;const a=i.slice(0,i.indexOf(n)+1);if(!r.name)return null;const o=n.ctx.wf.process.name;const c=r.name;const l=e.id;const h=this.getHashCode(e.value);return{type:t,process:o,activity:c,control:l,valueHash:h,wfPath:a}}getHashCode(t){let e=0;let s;if(!t||t.length===0)return e;for(let i=0;i<t.length;i++){s=t.charCodeAt(i);e=(e<<5)-e+s;e|=0}return e}}const r=t("polaris_analytics",class{constructor(t){e(this,t)}async analyticsHandler(t){const e=r.analyticsService.getPath(t);if(r.lastPath[0]===e[0])return;r.lastPath=e;const s=e.find(t=>t["wf-Workflow"]!==undefined);if(!s)return;e[0].addEventListener("blur",this.onBlur);r.analyticsService.send("click",e)}wfMessage(t){r.analyticsService.sendMessage(t)}onBlur(t){r.analyticsService.send("blur",r.lastPath);t.target.removeEventListener("blur",this.onBlur)}});r.lastPath=[null];r.analyticsService=new n;class a{constructor(t){this.ctx=t}async fetch(t){try{this.ctx.page.sendMessage({type:"START_LOADING"});const e=await fetch(this.resolveSetting(t.url),this.getConfig(t));if(e.status>=400){const s=await e.json();if(e.status>=401)this.ctx.page.sendMessage({type:"UN_AUTHORIZED",metadata:{endpoint:t,error:s}});throw{code:e.status,message:e.statusText,error:s}}return await e.json()}finally{setTimeout(()=>this.ctx.page.sendMessage({type:"END_LOADING"}))}}getConfig(t){return{method:t.method,mode:"cors",headers:Object.apply({"Content-Type":"application/json"},t.headers),redirect:"follow",referrer:"no-referrer",body:t.body?JSON.stringify(t.body):null}}resolveSetting(t,e=0){if(e>2)return t;const s=t.match(/\[[\w|_]+\]/g);if(!s)return t;let i=s.reduce(this.replace.bind(this),t);if(i.indexOf("[")>-1)i=this.resolveSetting(i,e++);return i}replace(t,e){let s=this.ctx.config.getSetting(e);if(s&&s.indexOf("[SELF]")>-1)return s.replace("[SELF]",t.replace(e,""));return t.replace(e,s)}}function o(t,[e,s]){const i=new Intl.NumberFormat(e,{style:"currency",currency:s});return i.format(+t)}class c{constructor(){this.currencyFormat=o}}class l{constructor(t){this.config=t;this.model={};this.sessionId=this.UUID();this.pipes=new c}getValue(t,e=this.model){if(t.indexOf("[")===0||t.indexOf("]")===t.length-1)return this.config.getSetting(t);const s=t.split(".").reduce((t,e)=>t?t[e]:undefined,Object.assign({},e));if(!t.match(/([a-z|A-Z]+\.[a-z|A-Z]+)+/g)&&s===undefined)return t;return s}getInterpolatedValue(t){if(!t)return t;const e=/\{\{\[*(?:(\w|\.|\||-)+)\]*\}\}/g;const s=t.match(e);if(!s||s.length===0)return t;return s.reduce((t,e)=>this.replaceAll(t,e),t)}setValue(t,e){if(t.indexOf("[")===0||t.indexOf("]")===t.length-1)this.config.addSetting(t,e);else this.model=this.merge(this.model,t,e)}save(){sessionStorage.setItem(this.sessionId,JSON.stringify(this.model))}load(){const t=sessionStorage.getItem(this.sessionId);this.clearCache();if(!t)return;this.model=JSON.parse(t)}clearCache(){sessionStorage.clear()}merge(t,e,s){if(!e)return;let i=Object.assign({},t);e.split(".").reduce((t,e,i,n)=>{t[e]=i==n.length-1?s:Object.assign({},t[e]);return t[e]},i);return i}UUID(){return"xxxxxxxxRxxxxR4xxxRyxxxRxxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=Math.random()*16|0,s=t=="x"?e:e&3|8;return s.toString(16)}))}replaceAll(t,e){const s=e.substring(2,e.length-2);const i=s.split("|");const n=i.slice(2);let r=this.getValue(i[0]);if(i&&i.length>1&&this.pipes[i[1]])r=this.pipes[i[1]](r,n);return t.replace(e,r)}}class h{constructor(){this.settings={}}getSetting(t){return this.settings[t]}addSetting(t,e){if(t.indexOf("[")===-1)t=`[${t}]`;this.settings[t]=e}}class d{constructor(){this.name="redirect";this.type="redirect-activity"}async execute(){var t;this.ctx.model.save();const e=`${(t=this.ctx.wf.process)===null||t===void 0?void 0:t.name}-${this.next}-${this.ctx.model.sessionId}`;window.location.href=`${this.location}?returnUrl=${e}`;return true}}class u{constructor(){this.name="finish";this.type="finish-activity"}async execute(){if(this.ctx.wf.stack.length===0){if(this.next)this.ctx.wf.goto(this.next);return true}const t=this.ctx.wf.stack.pop();this.ctx.wf.setProcess(t.process,t.activity);return true}}class f{constructor(){this.name="ipc";this.type="ipc-activity"}async execute(){if(this.process&&this.process.length>0){this.ctx.wf.stack.push({process:this.ctx.wf.process.name,activity:this.next});this.ctx.wf.setProcess(this.process,"start",this.next?false:true)}return true}}class g{constructor(){this.name="code";this.type="code-activity"}async execute(){this.eval(this.expression,this.ctx);if(this.next&&this.next.length>0)this.ctx.wf.goto(this.next);return true}eval(t,e){const s=new Function("ctx",t);return s(e)}}class p{constructor(){this.name="start";this.type="page-activity"}async execute(){if(this.ctx.page.controls)this.ctx.page.controls=this.controls||[];return true}}class x{constructor(){this.name="undefined";this.type="null-activity"}execute(){return new Promise((t,e)=>e("NULL Activity"))}}class m{constructor(){this.name="start";this.type="api-activity"}async execute(){await this.callEndpoints();this.gotoNext();return true}async callEndpoints(){for(const t of this.endpoints){t.body=this.getBody(t);await this.callEndpoint(this.ctx.http,t)}return true}async callEndpoint(t,e){return t.fetch(e).then(t=>this.setModel(e,t))}gotoNext(){if(this.next&&this.ctx)this.ctx.wf.goto(this.next)}getBody(t){if(!this.ctx||!this.ctx.model||t.method.toUpperCase()==="GET"||t.method.toUpperCase()==="DELETE")return null;const e=this.ctx.model;const s=t.mappings;let i={};s.filter(t=>t.direction==="out"||t.direction==="inout").forEach(t=>Object.assign(i,{[t.remote]:e.getValue(t.client)}));return i}setModel(t,e){if(!this.ctx||!this.ctx.model)return;const s=this.ctx.model;const i=t.mappings;if(!i||i.length===0)return Object.keys(e).forEach(t=>s.setValue(t,e[t]));i.filter(t=>t.direction==="in"||t.direction==="inout").forEach(t=>s.setValue(t.client,s.getValue(t.remote,e)))}}class y{constructor(){this.name="assign";this.type="assign-activity"}async execute(){const t=this.ctx.model.getInterpolatedValue(this.value);this.ctx.model.setValue(this.key,t);this.ctx.wf.goto(this.next);return true}}class v extends g{constructor(){super(...arguments);this.name="decision";this.type="decision-activity"}async execute(){const t=`return ${this.ctx.model.getInterpolatedValue(this.expression)};`;if(this.eval(t,this.ctx))this.ctx.wf.goto(this.trueAction);else this.ctx.wf.goto(this.falseAction);return true}}class w extends g{constructor(){super(...arguments);this.name="switch";this.type="switch-activity"}async execute(){for(let t of this.rules||[]){const e=`return ${this.ctx.model.getInterpolatedValue(t.expression)};`;if(this.eval(e,this.ctx)){this.ctx.wf.goto(t.next);return true}}throw new Error(`No valid rule in ${this.name} found !!`)}}class b{static create(t,e){if(!t||!t.type)return new x;let s=b.activities.find(e=>e.type===t.type);if(!s)return new x;return Object.assign(s,t,{ctx:e})}static add(t){let e=b.activities.find(e=>e.type===t.type);if(!e)b.activities.push(t)}}b.activities=[new x,new p,new m,new y,new g,new v,new f,new u,new d,new w];class E{constructor(t){this.ctx=t;this.stack=[]}async setProcess(t,e="start",s=true){try{if(s)this.stack=[];if(typeof t==="string"&&this.loader)t=await this.loader.load(t);this.process=t;this.activity=null;this.goto(e);this.ctx.page.sendMessage({type:"PROCESS_CHANGED",metadata:{stack:this.stack}})}catch(i){if(i){console.error(i);this.ctx.page.sendMessage({type:"ERROR",description:i.message,metadata:i})}}}goto(t){setTimeout(this.tryNext.bind(this,t))}async tryNext(t){try{this.ctx.page.sendMessage({type:"WORKFLOW_CHANGING"});await this.next(t);this.ctx.page.sendMessage({type:"WORKFLOW_CHANGED"})}catch(e){this.ctx.page.sendMessage({type:"ERROR",description:e===null||e===void 0?void 0:e.message,metadata:e})}}async next(t){var e;if(!this.process||!this.process.activities)return null;if(((e=this.ctx.wf.activity)===null||e===void 0?void 0:e.type)==="page-activity"&&!this.ctx.validator.validate(this.ctx))return null;let s=this.process.activities.find(e=>e.name==t);if(!s)throw new Error(`Activity ${t} not found`);this.activity=s;return await b.create(this.activity,this.ctx).execute()}}class O{constructor(t){this.name=t}setError(t,e,s){t.error=e;t.errorMessage=e?s:null;if(t.el){t.el.setAttribute("error",t.error?"true":"false");t.el.setAttribute("errorMessage",t.errorMessage)}if(t.el.nextSibling["attributes"]["wf-error"])t.el.nextSibling.textContent=t.errorMessage}}class S extends O{validate(t,e,s){const i=t.model.getValue(e.id);const n=i===null||i===undefined||i.length===0;super.setError(e,n,s.message);return!n}}class M extends O{validate(t,e,s){const i=t.model.getValue(e.id);const n=new RegExp(s.expression,"g");const r=n.exec(i);const a=r?true:false;super.setError(e,!a,s.message);return a}}class C extends O{validate(t,e,s){const i=+t.model.getValue(e.id);const n=i>=s.min&&i<=s.max;super.setError(e,!n,s.message);return n}}class I{constructor(){this.validators=[new S("required"),new M("regex"),new C("range")]}validate(t){if(!t.page||!t.page.controls)return true;let e=true;for(const s of t.page.controls)e=this.validateControl(t,s)&&e;return e}addValidator(t){const e=this.validators.find(e=>e.name===t.name);if(!e)this.validators.push(t)}validateControl(t,e){if(!e)return true;let s=true;for(const i in e.controls)s=this.validateControl(t,e.controls[i])&&s;if(e.validators&&e.validators.length>0){for(const i of e.validators){const n=this.validators.find(t=>t.name===i.name);if(!n)continue;if(!n.validate(t,e,i)){s=false;this.sendErrorMsg(t,n,e);break}}}return s}sendErrorMsg(t,e,s){t.page.sendMessage({type:"VALIDATION_ERROR",description:s.errorMessage,metadata:{validator:e.name,control:s.id}})}}class N{constructor(t){this.ctx=t}build(t,e){this.onInput=e;this.clearPage(t);this.ctx.controls.forEach(this.addComponent.bind(this,t))}clearPage(t){for(let e=t.childNodes.length-1;e>=0;e--)t.removeChild(t.childNodes[e])}addComponent(t,e){let s;if(e.tag==="polaris-workflow")s=this.createWorkflowElement(e);else s=this.createElement(e);t.appendChild(s);this.addErrorLabel(s)}createWorkflowElement(t){const e=document.createElement(t.tag);const s=Object.assign(e,t);s.setServices(this.ctx);return s}createElement(t){var e;const s=document.createElement(t.tag);const i={"wf-Workflow":"",ctx:this.ctx};const n=Object.assign(s,t,i);t.el=n;this.bind(n);this.bindCaption(n,t);(e=t.controls)===null||e===void 0?void 0:e.forEach(this.addComponent.bind(this,n));return n}bind(t){if(!t.id||t.value===undefined)return;const e=this.ctx.model.getValue(t.id);if(e!==undefined)t.value=e;this.ctx.model.setValue(t.id,t.value);t.oninput=this.onInput.bind(this,t)}bindCaption(t,e){this.interpolate("caption",t,e);this.interpolate("textContent",t,e);this.interpolate("innerHTML",t,e)}interpolate(t,e,s){if(!e[t])return;e[t]=this.ctx.model.getInterpolatedValue(s[t]||e[t])}addErrorLabel(t){if(!t.validators)return;const e=document.createElement("span");e.setAttribute("wf-error","error");t.parentNode.appendChild(e)}}class A{constructor(t){this.http=t}async load(t){return await this.http.fetch({url:`[WF]/${t}`,method:"get"})}}const V=t("polaris_workflow",class{constructor(t){e(this,t);this._components=[];this.page=this;this.ctx=this;this.http=new a(this.ctx);this.config=new h;this.model=new l(this.ctx.config);this.wf=new E(this.ctx);this.validator=new I;this.wfMessage=s(this,"wfMessage",7)}processChangeHandler(){this.load(this.process,this.activity,this.sessionId)}get controls(){return this._components}set controls(t){this._components=t;this._render()}async setServices(t){this.model=t.model;this.http=t.http;this.config=t.config;this.validator=t.validator}async load(t,e="start",s=""){if(s&&s.length>0){this.ctx.model.sessionId=s;this.ctx.model.load()}await this.wf.setProcess(t,e)}async addActivity(t){b.add(t)}async addValidator(t){this.validator.addValidator(t)}sendMessage(t){var e,s,i;const n={process:(e=this.wf.process)===null||e===void 0?void 0:e.name,activity:(s=this.wf.activity)===null||s===void 0?void 0:s.name,activityType:(i=this.wf.activity)===null||i===void 0?void 0:i.type,timestamp:Date.now()};this.wfMessage.emit(Object.assign(Object.assign({},t),n))}async componentWillLoad(){if(this.url){this.config.addSetting("[settingsUrl]",this.url);const t=await this.http.fetch({method:"GET",url:this.url});Object.keys(t).forEach(e=>this.config.addSetting(e,t[e]))}if(!this._loader){this._loader=new A(this.http);this.wf.loader=this._loader}if(this.parent)this.setServices(this.parent);if(this.process)this.load(this.process,this.activity,this.sessionId)}onInput(t){this.model.setValue(t.id,t.value);if(t.hasAttribute("error"))this.validator.validate(this)}_render(){const t=new N(this);t.build(this.el,this.onInput.bind(this))}get el(){return i(this)}static get watchers(){return{process:["processChangeHandler"]}}})}}}));