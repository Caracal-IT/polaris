!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t){this.ctx=t}async fetch(t){try{this.ctx.page.sendMessage({type:"START_LOADING"});const e=await fetch(this.resolveSetting(t.url),this.getConfig(t));if(e.status>=400){const s=await e.json();throw e.status>=401&&this.ctx.page.sendMessage({type:"UN_AUTHORIZED",metadata:{endpoint:t,error:s}}),{code:e.status,message:e.statusText,error:s}}return await e.json()}finally{setTimeout(()=>this.ctx.page.sendMessage({type:"END_LOADING"}))}}getConfig(t){return{method:t.method,mode:"cors",headers:Object.apply({"Content-Type":"application/json"},t.headers),redirect:"follow",referrer:"no-referrer",body:t.body?JSON.stringify(t.body):null}}resolveSetting(t,e=0){if(e>2)return t;const s=t.match(/\[[\w|_]+\]/g);if(!s)return t;let i=s.reduce(this.replace.bind(this),t);return i.indexOf("[")>-1&&(i=this.resolveSetting(i,e++)),i}replace(t,e){let s=this.ctx.config.getSetting(e);return s&&s.indexOf("[SELF]")>-1?s.replace("[SELF]",t.replace(e,"")):t.replace(e,s)}}function r(t,[e,s]){return new Intl.NumberFormat(e,{style:"currency",currency:s}).format(+t)}class n{constructor(){this.currencyFormat=r}}class o{constructor(t){this.config=t,this.model={},this.sessionId=this.UUID(),this.pipes=new n}getValue(t,e=this.model){if(0===t.indexOf("[")||t.indexOf("]")===t.length-1)return this.config.getSetting(t);const s=t.split(".").reduce((t,e)=>t?t[e]:void 0,Object.assign({},e));return t.match(/([a-z|A-Z]+\.[a-z|A-Z]+)+/g)||void 0!==s?s:t}getInterpolatedValue(t){if(!t)return t;const e=t.match(/\{\{\[*(?:(\w|\.|\||-)+)\]*\}\}/g);return e&&0!==e.length?e.reduce((t,e)=>this.replaceAll(t,e),t):t}setValue(t,e){0===t.indexOf("[")||t.indexOf("]")===t.length-1?this.config.addSetting(t,e):this.model=this.merge(this.model,t,e)}save(){sessionStorage.setItem(this.sessionId,JSON.stringify(this.model))}load(){const t=sessionStorage.getItem(this.sessionId);this.clearCache(),t&&(this.model=JSON.parse(t))}clearCache(){sessionStorage.clear()}merge(t,e,s){if(!e)return;let i=Object.assign({},t);return e.split(".").reduce((t,e,i,r)=>(t[e]=i==r.length-1?s:Object.assign({},t[e]),t[e]),i),i}UUID(){return"xxxxxxxxRxxxxR4xxxRyxxxRxxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}replaceAll(t,e){const s=e.substring(2,e.length-2).split("|"),i=s.slice(2);let r=this.getValue(s[0]);return s&&s.length>1&&this.pipes[s[1]]&&(r=this.pipes[s[1]](r,i)),t.replace(e,r)}}class a{constructor(){this.settings={}}getSetting(t){return this.settings[t]}addSetting(t,e){-1===t.indexOf("[")&&(t=`[${t}]`),this.settings[t]=e}}class c{constructor(){this.name="code",this.type="code-activity"}async execute(){return this.eval(this.expression,this.ctx),this.next&&this.next.length>0&&this.ctx.wf.goto(this.next),!0}eval(t,e){return new Function("ctx",t)(e)}}class l{constructor(){this.name="undefined",this.type="null-activity"}execute(){return new Promise((t,e)=>e("NULL Activity"))}}class h{static create(t,e){if(!t||!t.type)return new l;let s=h.activities.find(e=>e.type===t.type);return s?Object.assign(s,t,{ctx:e}):new l}static add(t){h.activities.find(e=>e.type===t.type)||h.activities.push(t)}}h.activities=[new l,new class{constructor(){this.name="start",this.type="page-activity"}async execute(){return this.ctx.page.controls&&(this.ctx.page.controls=this.controls||[]),!0}},new class{constructor(){this.name="start",this.type="api-activity"}async execute(){return await this.callEndpoints(),this.gotoNext(),!0}async callEndpoints(){for(const t of this.endpoints)t.body=this.getBody(t),await this.callEndpoint(this.ctx.http,t);return!0}async callEndpoint(t,e){return t.fetch(e).then(t=>this.setModel(e,t))}gotoNext(){this.next&&this.ctx&&this.ctx.wf.goto(this.next)}getBody(t){if(!this.ctx||!this.ctx.model||"GET"===t.method.toUpperCase()||"DELETE"===t.method.toUpperCase())return null;const e=this.ctx.model,s=t.mappings;let i={};return s.filter(t=>"out"===t.direction||"inout"===t.direction).forEach(t=>Object.assign(i,{[t.remote]:e.getValue(t.client)})),i}setModel(t,e){if(!this.ctx||!this.ctx.model)return;const s=this.ctx.model,i=t.mappings;if(!i||0===i.length)return Object.keys(e).forEach(t=>s.setValue(t,e[t]));i.filter(t=>"in"===t.direction||"inout"===t.direction).forEach(t=>s.setValue(t.client,s.getValue(t.remote,e)))}},new class{constructor(){this.name="assign",this.type="assign-activity"}async execute(){const t=this.ctx.model.getInterpolatedValue(this.value);return this.ctx.model.setValue(this.key,t),this.ctx.wf.goto(this.next),!0}},new c,new class extends c{constructor(){super(...arguments),this.name="decision",this.type="decision-activity"}async execute(){const t=`return ${this.ctx.model.getInterpolatedValue(this.expression)};`;return this.eval(t,this.ctx)?this.ctx.wf.goto(this.trueAction):this.ctx.wf.goto(this.falseAction),!0}},new class{constructor(){this.name="ipc",this.type="ipc-activity"}async execute(){return this.process&&this.process.length>0&&(this.ctx.wf.stack.push({process:this.ctx.wf.process.name,activity:this.next}),this.ctx.wf.setProcess(this.ctx.model.getInterpolatedValue(this.process),"start",!this.next)),!0}},new class{constructor(){this.name="finish",this.type="finish-activity"}async execute(){if(0===this.ctx.wf.stack.length)return this.next&&this.ctx.wf.goto(this.next),!0;const t=this.ctx.wf.stack.pop();return this.ctx.wf.setProcess(t.process,t.activity),!0}},new class{constructor(){this.name="redirect",this.type="redirect-activity"}async execute(){var t;this.ctx.model.save();const e=`${null===(t=this.ctx.wf.process)||void 0===t?void 0:t.name}-${this.next}-${this.ctx.model.sessionId}`;return window.location.href=`${this.location}?returnUrl=${e}`,!0}},new class extends c{constructor(){super(...arguments),this.name="switch",this.type="switch-activity"}async execute(){for(let t of this.rules||[]){const e=`return ${this.ctx.model.getInterpolatedValue(t.expression)};`;if(this.eval(e,this.ctx))return this.ctx.wf.goto(t.next),!0}throw new Error(`No valid rule in ${this.name} found !!`)}}];class d{constructor(t){this.ctx=t,this.stack=[]}async setProcess(t,e="start",s=!0){try{s&&(this.stack=[]),"string"==typeof t&&this.loader&&(t=await this.loader.load(t)),this.process=t,this.activity=null,this.goto(e),this.ctx.page.sendMessage({type:"PROCESS_CHANGED",metadata:{stack:this.stack}})}catch(t){t&&(console.error(t),this.ctx.page.sendMessage({type:"ERROR",description:t.message,metadata:t}))}}goto(t){setTimeout(this.tryNext.bind(this,t))}async tryNext(t){try{this.ctx.page.sendMessage({type:"WORKFLOW_CHANGING"}),await this.next(t),this.ctx.page.sendMessage({type:"WORKFLOW_CHANGED"})}catch(t){this.ctx.page.sendMessage({type:"ERROR",description:null==t?void 0:t.message,metadata:t})}}async next(t){var e;if(!this.process||!this.process.activities)return null;if("page-activity"===(null===(e=this.ctx.wf.activity)||void 0===e?void 0:e.type)&&!this.ctx.validator.validate(this.ctx))return null;let s=this.process.activities.find(e=>e.name==t);if(!s)throw new Error(`Activity ${t} not found`);return this.activity=s,await h.create(this.activity,this.ctx).execute()}}class u{constructor(t){this.name=t}setError(t,e,s){t.error=e,t.errorMessage=e?s:null,t.el&&(t.el.setAttribute("error",t.error?"true":"false"),t.el.setAttribute("errorMessage",t.errorMessage)),t.el.nextSibling.attributes["wf-error"]&&(t.el.nextSibling.textContent=t.errorMessage)}}class p extends u{validate(t,e,s){const i=t.model.getValue(e.id),r=null==i||0===i.length;return super.setError(e,r,s.message),!r}}class g extends u{validate(t,e,s){const i=t.model.getValue(e.id),r=!!new RegExp(s.expression,"g").exec(i);return super.setError(e,!r,s.message),r}}class x extends u{validate(t,e,s){const i=+t.model.getValue(e.id),r=i>=s.min&&i<=s.max;return super.setError(e,!r,s.message),r}}class f{constructor(){this.validators=[new p("required"),new g("regex"),new x("range")]}validate(t){if(!t.page||!t.page.controls)return!0;let e=!0;for(const s of t.page.controls)e=this.validateControl(t,s)&&e;return e}addValidator(t){this.validators.find(e=>e.name===t.name)||this.validators.push(t)}validateControl(t,e){if(!e)return!0;let s=!0;for(const i in e.controls)s=this.validateControl(t,e.controls[i])&&s;if(e.validators&&e.validators.length>0)for(const i of e.validators){const r=this.validators.find(t=>t.name===i.name);if(r&&!r.validate(t,e,i)){s=!1,this.sendErrorMsg(t,r,e);break}}return s}sendErrorMsg(t,e,s){t.page.sendMessage({type:"VALIDATION_ERROR",description:s.errorMessage,metadata:{validator:e.name,control:s.id}})}}class m{constructor(t){this.ctx=t}build(t,e){this.onInput=e,this.clearPage(t),this.ctx.controls.forEach(this.addComponent.bind(this,t))}clearPage(t){for(let e=t.childNodes.length-1;e>=0;e--)t.removeChild(t.childNodes[e])}addComponent(t,e){let s;s="polaris-workflow"===e.tag?this.createWorkflowElement(e):this.createElement(e),t.appendChild(s),this.addErrorLabel(s)}createWorkflowElement(t){const e=document.createElement(t.tag),s=Object.assign(e,t);return s.setServices(this.ctx),s}createElement(t){var e;const s=document.createElement(t.tag),i={"wf-Workflow":"",ctx:this.ctx},r=Object.assign(s,t,i);return t.el=r,this.bind(r),this.bindCaption(r,t),null===(e=t.controls)||void 0===e||e.forEach(this.addComponent.bind(this,r)),r}bind(t){if(!t.id||void 0===t.value)return;const e=this.ctx.model.getValue(t.id);void 0!==e&&(t.value=e),this.ctx.model.setValue(t.id,t.value),t.oninput=this.onInput.bind(this,t)}bindCaption(t,e){this.interpolate("caption",t,e),this.interpolate("textContent",t,e),this.interpolate("innerHTML",t,e)}interpolate(t,e,s){e[t]&&(e[t]=this.ctx.model.getInterpolatedValue(s[t]||e[t]))}addErrorLabel(t){if(!t.validators)return;const e=document.createElement("span");e.setAttribute("wf-error","error"),t.parentNode.appendChild(e)}}class y{constructor(t){this.http=t}async load(t){return await this.http.fetch({url:`[WF]/${t}`,method:"get"})}}class v extends HTMLElement{constructor(){super(...arguments),this._components=[],this.page=this,this.ctx=this,this.http=new i(this.ctx),this.config=new a,this.model=new o(this.ctx.config),this.wf=new d(this.ctx),this.validator=new f}static get observedAttributes(){return["process","url"]}get controls(){return this._components}set controls(t){this._components=t,this.render()}attributeChangedCallback(t,e,s){"url"===t?this.url=s:"process"===t&&(this.process=s,this.load(this.process,this.activity,this.sessionId))}async connectedCallback(){if(this.url){this.config.addSetting("[settingsUrl]",this.url);const t=await this.http.fetch({method:"GET",url:this.url});Object.keys(t).forEach(e=>this.config.addSetting(e,t[e]))}this._loader||(this._loader=new y(this.http),this.wf.loader=this._loader),this.parent&&this.setServices(this.parent),this.process&&this.load(this.process,this.activity,this.sessionId)}setServices(t){this.model=t.model,this.http=t.http,this.config=t.config,this.validator=t.validator}async load(t,e="start",s=""){s&&s.length>0&&(this.ctx.model.sessionId=s,this.ctx.model.load()),await this.wf.setProcess(t,e)}addActivity(t){h.add(t)}addValidator(t){this.validator.addValidator(t)}sendMessage(t){var e,s,i;const r={process:null===(e=this.wf.process)||void 0===e?void 0:e.name,activity:null===(s=this.wf.activity)||void 0===s?void 0:s.name,activityType:null===(i=this.wf.activity)||void 0===i?void 0:i.type,timestamp:Date.now()};document.dispatchEvent(new CustomEvent("wfMessage",{bubbles:!0,detail:Object.assign(Object.assign({},t),r)}))}onInput(t){this.model.setValue(t.id,t.value),t.hasAttribute("error")&&this.validator.validate(this)}render(){new m(this).build(this,this.onInput.bind(this))}}customElements.define("polaris-workflow",v)}]);